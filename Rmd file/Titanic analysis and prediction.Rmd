---
title: "Untitled"
author: "Kshitiz Sirohi"
date: "January 7, 2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

1- Loading of packages
2- Loading data
3-Understanding data:
    3.1- Exploring data
    3.2- Cleaning the data

```{r}
library(ggplot2)
library(dplyr)
library(randomForest)
```

```{r}
setwd("C:/Users/ksiro/Documents/")
t<- read.csv("train.csv",sep=",",header=TRUE)

te <- read.csv("test.csv",sep=",",header=TRUE)
te$Survived <- NA
df<-rbind(t,te)
df <- as.data.frame(df)
```

```{r}
summary(df)
head(df)
tail(df)
```

```{r}
## We saw that cabin column has too many missing values, so I have removed it.
df <- df[,-11]

## Checking how many missing values we have in each column
m <- as.data.frame(matrix(ncol=1,nrow=1))
for (i in c(1:11)) { m[i]<- sum(is.na(df[,i])) }
m

summary(df$Age)
df[which(is.na(df$Age)),6] <- mean(df$Age,na.rm=TRUE)
```
1- column 6 has 263 NAs, so we need to impute some value. It can be mode, median or mean depending upon the situation. 
In our case, I have imputed mean because the mode and median are almost similar so it did not matter which one I use. 
2- Column 2 also have 418 NAs but that is what we have to predict, so we do not bother about it.

```{r}
##impute NAs in empty spacE
summary(df$Fare)
which(is.na(df$Fare)) 
df$Fare[1044] <- median(df$Fare,na.rm=TRUE)
```
1- Some of the spaces are empty, that mean neither do they hold any value nor they have NA. So after finding the right index of those spaces in fare column, I have imputed median in it. 
2- The reason to impute median is that fare has some outliers which is skweing the mean value higher than median, which mean mean does not represent the actual picture.

```{r}
##mostly embarked from S so imnpute "S"
table(df$Embarked)
which(df$Embarked=="")
df$Embarked[c(62,830)] <- "S"
df$Embarked <- droplevels(df$Embarked)
table(df$Embarked)
```
1- Above we can see that most of the time the embarked has value "S", that is why it makes sense to impute "S" in empty spaces whose index number we got from "which" function and used it to impute value.
2- We also had to drop the empty level, since it was a factor we only need those factor that hold some value.


summary(df)

```{r}
##drop pasenger id
df <- df[,-1]
```
We do not need passenger ID for the prediciton of survival because unique ID cannot help in prediction.

```{r}
##seprating title out of names in training
df$Name <- as.character(df$Name)
lastname <- strsplit(df$Name,",")
a <- data.frame(matrix(nrow=1,ncol=1))
a<-as.list(a)
for (i in c(1:nrow(df))) { a[i] <- lastname[[i]][2]}
a<-as.character(a)
b <- strsplit(a[1:nrow(df)],". ")
title <- data.frame(matrix(ncol=1,nrow=1))
for (i in c(1:nrow(df))) { title [i] <- b[[i]][1]}
title <- trimws(title)
title <- as.data.frame(title)
df <- cbind(df,title)
df$title <- as.character(df$title)
```
1- In name column we are given full names of the passenger, I have taken out only the title of their name so that we can predict does having a higher title or lower title had any effect on the survival. Maybe higher title are given higher prefference than people that hae lower title.

```{r}
##we have cleared the data, now we can split it
test <- df[892: 1309,]
df <- df[1:891,] ## I am strong training as df aga
```
I split the data in two parts, one part is "df" again, which holds training values, and another is "test" which holds test values.


Exploration
```{r}
##most number of 3rd class passengers, almost half
aggregate(df$Survived,by=list(df$Pclass),FUN=mean) ##variying survival rate depending upon the class
ggplot(df,aes(x=Pclass,fill=factor(Survived))) + geom_histogram(stat="count")
```
observations:
1- Above we see that most of the passenger are from 3rd class category on ship.
2- In the plot we can see the survival rate of each one of those classes.

```{r}
#we see that people with high class had better chances of survival.
ggplot(df,aes(x=Pclass,fill=factor(Survived))) + geom_bar()
percent_survive_by_class <- df %>% group_by(Pclass) %>% summarise(survival_rate=sum(Survived==1)*100/ (survival_rate= sum(Survived ==1)+sum(Survived==0)) )
percent_survive_by_class
```
Observation: We see that people from 1st class have higher rate of survival than people from 3rd class.

```{r}
#sruvival vs fare
barplot(df$Fare)
#I see a few outliers
fare <- sort(df$Fare,decreasing = T)
head(fare)
top_fare <- tail(order(df$Fare),3)
df[top_fare,]
#all 3 with highest fare survived.
```
Observation:
1-I saw that their area few outliers in fare column.  In the barplot above it can bee seen that three are above 500 and their are more that are higher than 200 but their quantity is very less in comparision to the whole dataset. 
2-Above we can also see that all 3 passengers who paid 500 bucks have survived.

```{r}
fare <- fare[-c(1,2,3)]
head(fare)
summary(fare)

##mostly fare are from 5 to 15
ggplot(df,aes(Fare,color=I("red"),fill=I("green"),alpha=I(0.3))) + geom_histogram(binwidth = 1) + xlim(NA,50)

##we see that higher the fair higher the survival
ggplot(df,aes(x=Fare,fill=factor(Survived))) + geom_histogram()+ xlim(0,100)
```
Observation:
1- After removing the top three outliers, we can see that the mean value has changed. Not a very significant improvement but in some cases it can be significant.
2- In the one of the histogram above we can see that the most of the people paid between 5 to 30.
3- In the second chart above, we can see that higher the fare amount higher is the sruvival. That means people who paid maore were given more preference during emergency.



Survival vs class
```{r}
ggplot(df,aes(x=Pclass,fill=factor(Survived))) + geom_bar()
percent_survive_by_class <- df %>% group_by(Pclass) %>% summarise(survival_rate=sum(Survived==1)*100/ (survival_rate= sum(Survived ==1)+sum(Survived==0)) )
percent_survive_by_class
```
Observation: We see that people from 1st class have higher rate of survival than people from 3rd class.


survival vs embarked
```{r}
ggplot(df,aes(x=Embarked,fill=factor(Survived))) + geom_histogram(stat="count")
aggregate(df$Survived,by=list(df$Embarked),FUN=mean)
## there is sufficient difference in percentage, so we can use this also for prediction
```
Observation: In the table above we can see that only C has 55% survival rate. Which can also be seen in the graph given after the table above.

survival vs age
```{r}
ggplot(df,aes(x=Age)) + geom_density(col="green",fill="red",alpha=.4,size=1)
ggplot(df,aes(x=Age,fill=factor(Survived))) + geom_histogram(binwidth = 10)
```
Observation:
1- Most number of people on the ship was around 30 years of age. It can be seen in the plot above. There is a sudden spike in the density plot at age 30.
2- In the next plot we can see that as the age increased the survival rate also increassed. Meaning people that were either old or child, were given more preferences than middle age people during emergency.


sex vs survival
```{r}
ggplot(df,aes(x=Sex,fill=factor(Survived))) + geom_histogram(stat="count")
## Women had higher survival rate
```
Observation: In the plot above we can see that women had higher survival rate, meaning women were given preference during emergency.


Siblings and spouses
```{r}
ggplot(df,aes(x=SibSp,fill=factor(Survived))) + geom_bar(binwidth = .5)
##SURVIAL RATE DECREASSED AS THE RESPONSIBILITY INCREASED.
percent <- df %>% group_by(SibSp) %>% summarise(lived=sum(Survived==1),died= sum(Survived==0))
survival_rate <- (percent$lived)*100/(percent$lived + percent$died )
percent <- cbind(percent,survival_rate)
percent
ggplot(percent,aes(x=SibSp,y=survival_rate,col=I("red"))) + geom_line()
```
Observation: In percent table we can see that the survival rate is decreasing as the responsibility increase, by reponsibility I mean as the number of Siblings increased, in addition to spouses, the survival rate decreased.


Parent and child
```{r}
#having a parent or chind does not seem to efect the survial.
ggplot(df,aes(x=Parch,fill=factor(Survived))) + geom_bar(binwidth = .5)
percent2 <- df %>% group_by(Parch) %>% summarise(lived=sum(Survived==1),died= sum(Survived==0))
survival_rate2 <- (percent2$lived)*100/(percent2$lived + percent2$died )
percent2 <- cbind(percent2,survival_rate2)
percent2
ggplot(percent2,aes(x=Parch,y=survival_rate2,col=I("red"))) + geom_line()
```
Observations:
1- In the percent2 table above, we can see that there is not much variation in surivival rate depending upon the number of parent or child that individual have.
2- But, we can get a more clear picture if we combine SibSp and Parch and name it the whole family size. So let us do that.



Introducing New Feature (Family size)
```{r}
family_size <- df$SibSp + df$Parch + 1      ##family size for training
df <- cbind(df,family_size)

family_size <- test$SibSp + test$Parch + 1    ##family size for test
test <- cbind(test,family_size)
```
Observation: I have added the number of sibling and spouse to number of parents and chinlders and 1 for the person itself. This can be a new feature called family.

```{r}
##family size for training set
ggplot(df,aes(x=family_size,fill=factor(Survived))) + geom_bar(stat = "count")
percent3 <- df %>% group_by(family_size) %>% summarise(lived=sum(Survived==1),died= sum(Survived==0))
survival_rate3 <- (percent3$lived)*100/(percent3$lived + percent3$died )
percent3 <- cbind(percent3,survival_rate3)
percent3
ggplot(percent3,aes(x=family_size,y=survival_rate3,col=I("red"))) + geom_line()
```
Observations:
1- After calculating the total family size, I have shown the survival rate in with respect to each category of family size.
2- In second chart I have shown the trend of survival rate based on the percentage of people survived belonging to each category. 


```{r}
empty1 <- data.frame(matrix(c(0,0,0,0,0,0,0,0),nrow=2,ncol=4))
empty2 <- data.frame(matrix(c(0,0,0,0,0,0,0,0),nrow=2,ncol=4))
colnames(empty1) <- c("SibSp", "lived", "died","survival_rate")
colnames(empty2) <- c("Parch", "lived", "died","survival_rate2")
percent <- rbind(percent,empty1)
percent2 <- rbind(percent2,empty2)
dummy <- cbind(percent[,c(1,4)],percent2[,c(1,4)], percent3[,c(1,4)])
g <- ggplot(dummy,aes(x=family_size,y=survival_rate3,color=I("red"),group=2)) + geom_line() ## after adding family
g <- g + geom_line(aes(x=family_size,y=survival_rate2,color="green")) + geom_point(shape=16)## only parent and child
g <- g + geom_line(aes(x=family_size,y=survival_rate,color="blue")) + geom_line() ## only spouse and siblings
g
```
Now to compare them all I have created a combined chart.
(a) percent line chart that showed SibSp
(b) percent2 line chart that showed Parch
(c) percent3 line chart that showed SibSp + Parch + 1


Changing features of Title column 
```{r}
## survival vs title
table(df$title) ##we can merge some of them 

survival_by_title <- df %>% group_by(title) %>% summarise(value=mean(Survived)*100)
survival_by_title
##married women were saved most
##only 15% of men survived with mr title
##unmarried women with miss title also survived 70%
##master also survived
##mean women and upper title were given preferences

df$title[df$title!="Master" & df$title != "Miss" & df$title!= "Mr" & df$title!= "Mrs"] <- "Other"
table(df$title)
ggplot(df,aes(x=title,fill=factor(Survived))) + geom_bar()

##change title for test also
test$title[test$title!="Master" & test$title != "Miss" & test$title!= "Mr" & test$title!= "Mrs"] <- "Other"
```
Observation:
1- I have cahnged the feature named title. We can see that there are many different kind of title, then it makes sense to combine the less frequent ones together and let the more frequent ones as they are.
2- Then in the table we can see the title as well as their respective survival rate. We see that Womens are given most preference during emergency with Miss having 70% survival and Mrs having 80% survival rate.
3- Men with the tiel Mr., meaning an average man on the ship was given least preference.
4- We can also see it in the barplot above, where each title being presented with respective survival rate in blue. 
5- Forgeting to change the title for test dataset also would be a mistake because the traning and testing dataset must have the consistency.




```{r}
ggplot(df,aes(x=Pclass,fill=factor(Survived))) + geom_bar()
percent_survive_by_class <- df %>% group_by(Pclass) %>% summarise(survival_rate=sum(Survived==1)*100/ (survival_rate= sum(Survived ==1)+sum(Survived==0)) )
percent_survive_by_class
```
Observation: We see that people from 1st class have higher rate of survival than people from 3rd class.


Normalization
```{r}
##normalize continous variables
norm <- function(x){(x-min(x))/(max(x)-min(x))}

df$Age<- norm(df$Age)
df$Fare<-  norm(df$Fare)
test$Age<-  norm(test$Age)
test$Fare <- norm(test$Fare)

##subset only valuebale columns
train <- df[,c(1,2,4,5,9,10,11,12)]
test <- test[,c(1,2,4,5,9,10,11,12)]
```
In classification problem, we need to normalize the countinous result so that we can accomodate those continous variables between 0 and 1. To do that, I have created a function called norm and then called fare and age varible because they were continous. Both for testing and training dataset.

```{r}
train$Pclass <- as.factor(train$Pclass)
train$title<- as.factor(train$title)
train$Embarked <- as.factor(df$Embarked)
test$Pclass <- as.factor(test$Pclass)
test$title<- as.factor(test$title)
```
Since we know we have a classification probelem at hand, it is reasonable to convert evething into factor. Both for training and testing dataset.

```{r}
ramfor <- randomForest( factor(Survived) ~ Pclass + Sex + Age + Fare + Embarked + title + family_size, data = train)
ramfor
varImpPlot(ramfor)
pr <- predict(ramfor,test)
```

```{r}
confusion_matrix <- ramfor[5]
confusion_matrix <- as.data.frame(confusion_matrix)
Accuracy <- (confusion_matrix[1,1] + confusion_matrix[2,2] )/(confusion_matrix[1,2]+confusion_matrix[2,2] +confusion_matrix[2,1] +confusion_matrix[1,1]  )

Accuracy
```







